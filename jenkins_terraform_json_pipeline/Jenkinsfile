import groovy.json.JsonSlurper

pipeline {
    agent any

    environment {
        // Reusable Terraform flags ‚Äì declared variables passed via CLI
        TF_FLAGS = "-var 'instance_type=t2.micro' -var 'key_name=My-Devops-Key' -var 'owner=jack'"
        TF_PLUGIN_CACHE_DIR = "C:\\TerraformPluginCache"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Read JSON Config') {
            steps {
                script {
                    def configFilePath = 'jenkins_terraform_json_pipeline/config.json'

                    if (!fileExists(configFilePath)) {
                        error "‚ùå config.json not found at path: ${configFilePath}"
                    }

                    def jsonFile = readFile(configFilePath)
                    def config = new JsonSlurper().parseText(jsonFile)

                    env.ENV = config.env
                    env.REGION = config.region
                    env.MODULES = config.modules.join(',')  // comma separated
                }
            }
        }

        stage('Terraform Init/Apply for Modules') {
            steps {
                script {
                    def modules = env.MODULES.split(',')

                    modules.each { mod ->
                        echo "üîß Processing module: ${mod}"

                        def modulePath = "jenkins_terraform_json_pipeline\\modules\\${mod}"

                        if (fileExists("${modulePath}/main.tf")) {
                            dir(modulePath) {
                                catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                                    withEnv(["TF_PLUGIN_CACHE_DIR=${env.TF_PLUGIN_CACHE_DIR}"]) {
                                        bat """
                                            echo Running terraform in: ${modulePath}
                                            terraform init
                                            terraform apply ${env.TF_FLAGS} -auto-approve
                                        """
                                    }
                                }
                            }
                        } else {
                            echo "‚ö†Ô∏è Skipping ${mod} ‚Äì main.tf not found"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "‚úÖ Pipeline completed for ENV: ${env.ENV}"
        }
    }
}
