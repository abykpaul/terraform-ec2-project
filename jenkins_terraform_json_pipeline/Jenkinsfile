import groovy.json.JsonSlurper

pipeline {
    agent any

    environment {
        TF_PLUGIN_CACHE_DIR = "C:\\TerraformPluginCache"
        TF_FLAGS = "-var 'instance_type=t2.micro' -var 'key_name=My-Devops-Key' -var 'owner=jack'"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Parse config.json') {
            steps {
                script {
                    def filePath = 'jenkins_terraform_json_pipeline/config.json'

                    // ‚úÖ Check if file exists
                    if (!fileExists(filePath)) {
                        error "‚ùå config.json file not found at: ${filePath}"
                    }

                    def jsonFile = readFile(filePath)
                    def config = new JsonSlurper().parseText(jsonFile)

                    // ‚úÖ Validate required keys
                    if (!config.env || !config.region || !config.modules) {
                        error "‚ùå config.json must include 'env', 'region', and 'modules'"
                    }

                    // ‚úÖ Assign values safely
                    env.ENV = config.env.toString()
                    env.REGION = config.region.toString()
                    env.MODULES = config.modules.join(',')

                    echo "‚úÖ ENV: ${env.ENV}"
                    echo "üåç REGION: ${env.REGION}"
                    echo "üì¶ MODULES: ${env.MODULES}"
                }
            }
        }

        stage('Terraform Modules Apply') {
            steps {
                script {
                    def modules = env.MODULES.split(',')

                    modules.each { mod ->
                        echo "üîß Processing module: ${mod}"

                        def modulePath = "jenkins_terraform_json_pipeline\\modules\\${mod}"

                        // ‚úÖ Ensure module folder and main.tf exists
                        if (fileExists("${modulePath}/main.tf")) {
                            dir(modulePath) {
                                catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                                    withEnv(["TF_PLUGIN_CACHE_DIR=${env.TF_PLUGIN_CACHE_DIR}"]) {
                                        bat """
                                            echo Running terraform in: ${modulePath}
                                            terraform init
                                            terraform apply ${env.TF_FLAGS} -auto-approve
                                        """
                                    }
                                }
                            }
                        } else {
                            echo "‚ö†Ô∏è Skipping module '${mod}' ‚Äî main.tf not found in ${modulePath}"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "üì¶ Pipeline completed for ENV: ${env.ENV}"
        }
    }
}
