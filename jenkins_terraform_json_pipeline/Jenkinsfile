import groovy.json.JsonSlurper

pipeline {
    agent any

    stages {
        stage('Terraform Loop Apply') {
            steps {
                script {
                    // âœ… Step 1: Parse JSON once
                    def json = new JsonSlurper().parseText(readFile('jenkins_terraform_json_pipeline/config.json'))

                    // âœ… Step 2: Extract ONLY serializable variables
                    def modules = json.modules.collect { it.toString() }              // List<String>
                    def instance_type = json.instance_type.toString()
                    def key_name = json.key_name.toString()
                    def owner = json.owner.toString()

                    // âœ… Step 3: Loop over module names (Strings only)
                    for (String module : modules) {
                        def path = "jenkins_terraform_json_pipeline/modules/${module}"
                        echo "ðŸš€ Running Terraform for module: ${module}"

                        // Set terraform vars as environment strings
                        def tfVars = [
                            "TF_VAR_instance_type=${instance_type}",
                            "TF_VAR_key_name=${key_name}",
                            "TF_VAR_owner=${owner}"
                        ]

                        dir(path) {
                            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                                withEnv(tfVars) {
                                    bat "terraform init"
                                    bat "terraform apply -auto-approve"
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
