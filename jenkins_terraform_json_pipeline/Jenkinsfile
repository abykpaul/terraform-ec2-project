import groovy.json.JsonSlurper

pipeline {
    agent any

    stages {
        stage('Terraform Deploy') {
            steps {
                script {
                    // âœ… Step 1: Parse and extract from config.json
                    def configFile = readFile 'jenkins_terraform_json_pipeline/config.json'
                    def parsed = new JsonSlurper().parseText(configFile)

                    // âœ… Step 2: Extract primitives (avoid LazyMap)
                    def modules = parsed.modules.collect { it.toString() }
                    def instanceType = parsed.instance_type.toString()
                    def keyName = parsed.key_name.toString()
                    def owner = parsed.owner.toString()

                    // âœ… Step 3: Loop through modules
                    for (moduleName in modules) {
                        def modulePath = "jenkins_terraform_json_pipeline/modules/${moduleName}"
                        echo "ðŸ”§ Running module: ${moduleName}"

                        dir(modulePath) {
                            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                                withEnv([
                                    "TF_VAR_instance_type=${instanceType}",
                                    "TF_VAR_key_name=${keyName}",
                                    "TF_VAR_owner=${owner}"
                                ]) {
                                    bat "terraform init"
                                    bat "terraform apply -auto-approve"
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "âœ… Pipeline completed."
        }
    }
}
