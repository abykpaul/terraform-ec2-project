import groovy.json.JsonSlurper

pipeline {
    agent any

    stages {
        stage('Parse & Apply Terraform') {
            steps {
                checkout scm
                script {
                    def jsonText = readFile('config.json')
                    def config = new JsonSlurper().parseText(jsonText)

                    def tfFlags = ""
                    config.vars.each { k, v ->
                        tfFlags += "-var '${k}=${v}' "
                    }

                    config.modules.each { mod ->
                        echo "Terraform apply for module: ${mod}"
                        bat """
                            cd modules\\${mod}
                            terraform init
                            terraform apply ${tfFlags} -auto-approve
                        """
                    }
                }
            }
        }
    }
}
