import groovy.json.JsonSlurper

pipeline {
    agent any

    environment {
        TF_PLUGIN_CACHE_DIR = "C:\\TerraformPluginCache"
        TF_FLAGS = "-var 'instance_type=t2.micro' -var 'key_name=My-Devops-Key' -var 'owner=jack'"
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

        stage('Read JSON Config') {
            steps {
                script {
                    def jsonPath = 'config.json' // ‚úÖ Update if it's inside a subfolder
                    if (fileExists(jsonPath)) {
                        def jsonFile = readFile(jsonPath)
                        def config = new JsonSlurper().parseText(jsonFile)

                        env.ENV = config.env
                        env.REGION = config.region
                        env.MODULES = config.modules.join(',')  // Convert list to comma-separated string

                        echo "‚úÖ ENV: ${env.ENV}"
                        echo "üåç REGION: ${env.REGION}"
                        echo "üì¶ MODULES: ${env.MODULES}"
                    } else {
                        error "‚ùå config.json not found at path: ${jsonPath}"
                    }
                }
            }
        }

        stage('Terraform Init/Apply for Modules') {
            steps {
                script {
                    def modules = env.MODULES.split(',')

                    modules.each { mod ->
                        def modulePath = "jenkins_terraform_json_pipeline\\modules\\${mod}"
                        echo "üîß Processing module: ${mod}"

                        if (fileExists("${modulePath}/main.tf")) {
                            dir(modulePath) {
                                catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
                                    withEnv(["TF_PLUGIN_CACHE_DIR=${env.TF_PLUGIN_CACHE_DIR}"]) {
                                        bat """
                                            echo üöÄ Running terraform init/apply in: ${modulePath}
                                            terraform init
                                            terraform apply ${env.TF_FLAGS} -auto-approve
                                        """
                                    }
                                }
                            }
                        } else {
                            echo "‚ö†Ô∏è Skipping ${mod} ‚Äî main.tf not found in ${modulePath}"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "‚úÖ Pipeline completed for ENV: ${env.ENV}"
        }
    }
}
