import groovy.json.JsonSlurper

pipeline {
    agent any

    stages {
        stage('Read Config and Deploy') {
            steps {
                script {
                    def configRaw = readFile('jenkins_terraform_json_pipeline/config.json')
                    def jsonObj = new JsonSlurper().parseText(configRaw)

                    // ✅ Extract values immediately
                    def modules = jsonObj.modules.collect { it.toString() }
                    def instanceType = jsonObj.instance_type.toString()
                    def keyName = jsonObj.key_name.toString()
                    def owner = jsonObj.owner.toString()

                    // ❗ Do NOT use `jsonObj` after this point

                    modules.each { moduleName ->
                        def modulePath = "jenkins_terraform_json_pipeline/modules/${moduleName}"
                        echo "🔧 Processing module: ${moduleName}"

                        dir(modulePath) {
                            catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                                withEnv([
                                    "TF_VAR_instance_type=${instanceType}",
                                    "TF_VAR_key_name=${keyName}",
                                    "TF_VAR_owner=${owner}"
                                ]) {
                                    bat "terraform init"
                                    bat "terraform apply -auto-approve"
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "✅ Pipeline Finished"
        }
    }
}
