import groovy.json.JsonSlurper

pipeline {
    agent any

    stages {
        stage('Parse JSON Config') {
            steps {
                script {
                    // ‚úÖ Correct path to config.json
                    def jsonFile = readFile('jenkins_terraform_json_pipeline/config.json')
                    def jsonObj = new JsonSlurper().parseText(jsonFile)

                    echo "üîç ENV: ${jsonObj.env}"
                    echo "üåç REGION: ${jsonObj.region}"

                    // Example: loop through modules (if present)
                    jsonObj.modules.each { moduleName ->
                        echo "üì¶ Module to deploy: ${moduleName}"
                    }
                }
            }
        }

        stage('Terraform Apply Modules') {
            steps {
                script {
                    def jsonFile = readFile('jenkins_terraform_json_pipeline/config.json')
                    def jsonObj = new JsonSlurper().parseText(jsonFile)

                    jsonObj.modules.each { moduleName ->
                        echo "üîß Processing module: ${moduleName}"

                        def modulePath = "jenkins_terraform_json_pipeline/modules/${moduleName}"
                        if (fileExists("${modulePath}/main.tf")) {
                            dir("${modulePath}") {
                                catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                                    withEnv([
                                        "TF_VAR_instance_type=${jsonObj.instance_type}",
                                        "TF_VAR_key_name=${jsonObj.key_name}",
                                        "TF_VAR_owner=${jsonObj.owner}"
                                    ]) {
                                        bat "terraform init"
                                        bat "terraform apply -auto-approve"
                                    }
                                }
                            }
                        } else {
                            echo "‚ö†Ô∏è main.tf not found for module: ${moduleName}"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            echo "üì¶ Pipeline completed for ENV: ${params.ENV ?: 'dev'}"
        }
    }
}
